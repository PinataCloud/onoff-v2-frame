const t=new Set,e=new Set,s=new Set(["w","a","s","d"," ","ArrowUp","ArrowDown","ArrowLeft","ArrowRight"]),i=()=>t.has("w")||t.has("ArrowUp")||e.has(0)||e.has(12),n=()=>t.has("a")||t.has("ArrowLeft")||e.has(14),h=()=>t.has("d")||t.has("ArrowRight")||e.has(15);document.addEventListener("keydown",e=>{t.add(e.key),s.has(e.key)&&e.preventDefault()}),document.addEventListener("keyup",({key:e})=>{t.delete(e)});const o=document.getElementById("up-button"),r=document.querySelector("#right-button"),a=document.querySelector("#left-button"),d=document.getElementById("toggle-button");o&&r&&a&&d?(o.addEventListener("touchstart",e=>{console.log("Touch started on up button"),e.preventDefault(),e.stopPropagation(),t.add("w")},{passive:!1}),o.addEventListener("touchend",e=>{console.log("Touch ended on up button"),e.preventDefault(),e.stopPropagation(),t.delete("w")},{passive:!1}),o.addEventListener("mousedown",e=>{console.log("Mouse down on up button"),t.add("w")}),o.addEventListener("mouseup",e=>{console.log("Mouse up on up button"),t.delete("w")}),r.addEventListener("mousedown",e=>{e.preventDefault(),n()&&(t.delete("a"),a.classList.remove("enabled")),h()?(t.delete("d"),r.classList.remove("enabled")):(t.add("d"),r.classList.add("enabled"))}),a.addEventListener("mousedown",e=>{e.preventDefault(),h()&&(t.delete("d"),r.classList.remove("enabled")),n()?(t.delete("a"),a.classList.remove("enabled")):(t.add("a"),a.classList.add("enabled"))})):console.warn("Some control buttons could not be found on the page");const l=new Map,c=(t,e)=>{l.has(t)||l.set(t,[]),l.get(t).push(e)};requestAnimationFrame(function t(s){const i=navigator.getGamepads()[0];i?(i.buttons.forEach((t,s)=>{if(t.pressed){if(!e.has(s)){const t=l.get(s);t&&t.forEach(t=>t())}e.add(s)}else e.delete(s)}),requestAnimationFrame(t)):e.clear()});const u=function(t,e){return t=Math.ceil(t),e=Math.floor(e),Math.floor(Math.random()*(e-t))+t};var g=[[[24,239],[724,244],[[0,288,330,192,1],[438,288,330,192,1]],[]],[[371,51],[724,404],[[0,100,768,16,1],[0,216,768,16,0],[0,332,768,16,1],[0,448,768,32,0]],[]],[[24,239],[724,244],[[0,288,330,192,1],[438,288,330,192,0]],[]],[[23,263],[724,268],[[0,312,768,8,1],[380,0,8,312,1],[0,408,768,72,0]],[]],[[116,96],[628,412],[[64,448,128,32,!1],[320,448,128,32,!0],[576,448,128,32,!1]],[]],[[24,399],[604,152],[[0,448,768,32,1],[128,320,512,8,1],[632,328,8,120,1],[128,192,512,8,1],[128,200,8,120,1],[640,384,128,8,0],[0,256,128,8,0]],[]],[[16,275],[566,248],[[0,0,768,64,1],[0,64,128,192,1],[0,324,248,92,1],[0,416,768,64,1],[192,132,180,96,1],[440,64,100,224,1],[620,112,72,245,1],[192,228,56,96,1],[300,288,320,69,1]],[]],[[16,367],[704,84],[[0,416,244,64,1],[524,128,244,352,1],[288,320,64,160,0],[416,224,64,256,0]],[]],[[104,175],[176,32],[[96,224,56,8,1],[96,232,56,8,0],[144,72,8,152,1],[152,72,8,168,0],[160,72,128,92,1],[160,164,256,92,1],[160,256,384,92,1],[544,256,8,92,0],[160,348,512,92,1],[160,440,512,8,0],[552,340,120,8,0]],[]],[[16,422],[724,416],[[0,472,48,8,1],[0,376,48,8,0],[0,280,48,8,1],[0,184,96,8,0],[384,456,384,24,1]],[]],[[16,239],[724,244],[[0,288,768,192,1],[336,0,96,288,1]],[]],[[16,56],[724,216],[0,1,2,3,4,5,6,7].map(t=>[96*t,u(240,300),u(24,72),u(24,180),u(0,2)]),[]],[[48,383],[696,384],[[48,432,24,24,1],[156,348,24,24,0],[48,264,24,24,1],[156,180,24,24,0],[264,180,24,24,1],[372,180,24,24,0],[480,180,24,24,1],[588,180,24,24,0],[696,264,24,24,1],[588,348,24,24,0],[696,432,24,24,1]],[]],[[24,8],[724,u(128,416)],[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23].map(t=>[32*t,u(64,464),8,8,u(0,2)]),[]],[[372,391],[372,20],[[320,440,128,8,1],[320,344,128,8,0],[320,248,128,8,1],[320,152,128,8,0]],[[320,448,128,8,1,"down"],[320,352,128,8,0,"down"],[320,256,128,8,1,"down"],[320,160,128,8,0,"down"]]],[[372,15],[372,418],[[320,64,128,16,1],[256,80,256,128,0],[320,208,128,16,1],[348,224,72,160,1],[348,384,8,96,1],[356,384,8,96,0],[412,384,8,96,1],[404,384,8,96,0]],[[312,64,8,16,1,"left"],[448,64,8,16,1,"right"],[312,208,8,16,1,"left"],[448,208,8,16,1,"right"]]],[[24,64],[724,u(128,416)],[[0,u(128,352),768,2,!0]],[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15].map(t=>[48*t,u(128,352),16,8,u(0,2),"up"])],[[371,20],[372,372],[[336,320,96,8,!0],[336,416,96,8,!0],[336,328,8,88,!0],[424,328,8,88,!0]],[[336,312,96,8,!0,"up"]]],[[371,20],[584,404],[[0,152,368,8,!0],[0,248,448,8,!0],[0,344,528,8,!0]],[[0,144,368,8,!0,"up"],[0,240,448,8,!0,"up"],[0,336,528,8,!0,"up"]]],[[12,312],[725,307],[[0,152,768,72,!0],[0,362,64,8,!0],[192,362,128,8,!0],[448,362,128,8,!0],[704,362,64,8,!0]],[[0,224,768,8,!0,"down"]]],[[371,20],[372,404],[[320,384,128,8,!0],[320,272,128,8,!1],[320,168,128,8,!0]],[[320,376,128,8,!0,"up"],[320,264,128,8,!1,"up"],[320,160,128,8,!0,"up"]]],[[63,263],[660,272],[[48,312,96,96,1],[144,124,48,284,1],[192,124,96,96,1],[192,312,96,96,0],[288,124,48,284,1],[336,312,96,96,1],[432,124,48,284,1],[480,124,96,96,1],[480,312,96,96,0],[576,124,48,284,1],[624,312,96,96,1]],[[232,304,16,8,0,"up"],[520,304,16,8,0,"up"]]],[[148,254],[600,266],[[94,176,8,128,!0],[222,176,8,128,!0],[94,168,136,8,!0],[94,304,136,8,!0],[318,176,8,128,!0],[446,176,8,128,!0],[318,168,136,8,!0],[318,304,136,8,!0],[542,176,8,128,!0],[670,176,8,128,!0],[542,168,136,8,!0],[542,304,136,8,!0]],[]],[[400,20],[372,432],[],[[0,96,384,8,!0,"up"],[0,104,384,8,!1,"down"],[400,240,368,8,!0,"up"],[400,248,368,8,!1,"down"],[0,384,384,8,!0,"up"],[0,392,384,8,!1,"down"]]],[[368,14],[269,419],[],[[328,32,8,80,1,"right"],[320,32,8,80,0,"left"],[424,32,8,80,1,"left"],[432,32,8,80,0,"right"],[280,175,8,80,1,"right"],[272,174,8,80,0,"left"],[376,175,8,80,1,"left"],[384,175,8,80,0,"right"],[232,320,8,80,1,"right"],[224,319,8,80,0,"left"],[328,320,8,80,1,"left"],[336,319,8,80,0,"right"]]]],p=t=>new Promise((e,s)=>{let i=performance.now();requestAnimationFrame(function s(n){if(n>=i+t)return e();requestAnimationFrame(s)})});class m{constructor(t){this.element=t,this.bounds={}}get hidden(){return this.element.hasAttribute("hidden")}set hidden(t){t?this.element.setAttribute("hidden",""):this.element.removeAttribute("hidden")}get x(){return this._x}set x(t){this._x=t||0,this.element.setAttribute("x",Math.round(this.x))}get y(){return this._y}set y(t){this._y=t||0,this.element.setAttribute("y",Math.round(this.y))}get width(){return this._width}set width(t){this._width=Math.max(0,t||0),this.element.setAttribute("width",Math.round(this.width))}get height(){return this._height}set height(t){this._height=Math.max(0,t||0),this.element.setAttribute("height",Math.round(this.height))}get top(){return this.y}get bottom(){return this.y+this.height}set bottom(t){this.y=(t||0)-this.height}get left(){return this.x}get right(){return this.x+this.width}set right(t){this.x=(t||0)-this.width}set bottom(t){this.y=t-this.height}isLeftOf(t){return this.right<=t.left}isRightOf(t){return this.left>=t.right}isAbove(t){return this.bottom<=t.top}isBelow(t){return this.top>=t.bottom}overlaps(t){return this.left<t.right&&this.right>t.left&&this.top<t.bottom&&this.bottom>t.top}append({element:t}){this.element.appendChild(t)}remove(){this.element.remove()}}var w=t=>document.createElementNS("http://www.w3.org/2000/svg",t);class y extends m{constructor(t,e){super(w("svg")),this.element.innerHTML='\n    <svg id="goal"><g id="inner-goal"><g id="inner-goal-finish">\n      <path d="M12 19.26L6.37 22.1a1 1 0 0 1-1.44-1.07l1.05-5.98-4.47-4.22a1 1 0 0 1 .55-1.72l6.22-.88 2.83-5.5a1 1 0 0 1 1.78 0l2.83 5.5 6.22.88a1 1 0 0 1 .55 1.72l-4.47 4.22 1.05 5.98a1 1 0 0 1-1.44 1.07L12 19.26z"/>\n    </g></g></svg>',this.width=22,this.height=20,this.load(t,e)}load(t,e){this.x=t,this.y=e}toJSON(){return[Math.round(this.x),Math.round(this.y)]}}class b extends m{constructor(t,e){super(w("svg")),this.element.innerHTML='\n    <svg id="guy" width="26.95" height="47" viewBox="0 0 600 800" xmlns="http://www.w3.org/2000/svg">\n      <g id="inner-guy">\n        <path d="M324.45 628.77L350.02 681.21H194.56L219.98 628.77H194.56L220.47 575.32H323.95L350.02 628.77H324.45Z" fill="#CE3F8F"/>\n        <path d="M221.64 681.21H322.95V708.54C322.95 736.5 300.25 759.19 272.3 759.19C244.34 759.19 221.65 736.49 221.65 708.54V681.21H221.64Z" fill="#6D3AC6"/>\n        <path d="M538.23 628.77L563.8 681.21H408.34L433.76 628.77H408.34L434.25 575.32H537.73L563.8 628.77H538.23Z" fill="#CE3F8F"/>\n        <path d="M435.42 681.21H536.73V708.54C536.73 736.5 514.03 759.19 486.08 759.19C458.12 759.19 435.43 736.49 435.43 708.54V681.21H435.42Z" fill="#6D3AC6"/>\n        <path d="M534.53 517.79L573.61 575.32H184.75L223.62 517.67H184.75L223.62 459.28H197.71L223.62 401.08L327.15 416.17L534.53 415.59L560.24 459.28H534.46L534.53 459.39L573.61 517.67H534.46L534.53 517.79Z" fill="#FFDD00"/>\n        <path d="M215.25 471.85L236.59 491.92L272.87 457.72L308.11 492.7L344.12 458.5L380.13 492.7L415.37 457.72L451.39 491.92L487.66 457.46L494.37 464.17L517.48 485.99L538.98 466.02L547.31 478.44L517.74 508.01L517.56 507.83L487.14 477.67L451.13 513.68L415.11 477.67L379.1 513.68L343.86 478.45L307.85 512.65L272.87 477.93L236.85 513.94L206.75 484.63" fill="black"/>\n        <path d="M223.6 401.08C223.6 384.53 220.57 362.73 212.8 350.3C202.44 333.72 183.78 322.32 147.51 322.06L146.99 342.79C159.94 342.27 172.38 343.57 183 350.3C192.07 356 199.58 365.33 205.28 380.87C173.67 369.99 155.53 373.36 142.84 381.65C136.1 386.05 130.92 391.5 126 397.45L140.25 410.66C141.03 409.36 142.06 408.33 142.84 407.29C158.39 388.89 176.26 389.41 195.18 399.52C153.98 419.21 147.51 453.93 149.58 479.06C151.39 479.32 169.79 479.06 169.79 479.06C167.98 454.71 182.75 421.24 219.03 411.4L223.61 401.08H223.6Z" fill="#6D3AC6"/>\n        <path d="M547.31 415.85L327.52 416.16L346.93 355.99H327.71L346.93 304.18H527.98L547.31 356.25H527.98L547.31 415.85Z" fill="#1DB9D2"/>\n        <path d="M555.36 304.44L322.92 304.7L360.92 226.71H335.13L373.38 151.57L555.36 191.47V304.44Z" fill="#FFDD00"/>\n        <path d="M555.36 304.44V191.47C555.36 191.47 622.26 206.53 636.65 243.78C637.69 246.47 638.12 249.36 638.12 252.24C640.83 302.89 555.36 304.44 555.36 304.44Z" fill="#CE3F8F"/>\n        <path d="M498.31 178.96C559.2 94.49 589.29 52.73 565.2 32.26C549.4 18.79 526.14 30.17 491.42 56.08C490.12 83.8 485.44 121.87 476.63 174.21L498.31 178.96Z" fill="#008599"/>\n        <path d="M472.97 4.79999C440.06 -3.23001 421.06 49.49 373.38 151.57L479.46 174.83C488.27 122.49 493.11 84.21 492.92 54.55C494.22 24.75 489.03 8.68999 472.97 4.79999Z" fill="#1DB9D2"/>\n        <path d="M484.67 254.99C498.135 254.99 509.05 244.075 509.05 230.61C509.05 217.145 498.135 206.23 484.67 206.23C471.205 206.23 460.29 217.145 460.29 230.61C460.29 244.075 471.205 254.99 484.67 254.99Z" fill="white"/>\n        <path d="M484.67 242.41C491.187 242.41 496.47 237.127 496.47 230.61C496.47 224.093 491.187 218.81 484.67 218.81C478.153 218.81 472.87 224.093 472.87 230.61C472.87 237.127 478.153 242.41 484.67 242.41Z" fill="black"/>\n        <path d="M555.36 300.1V304.44H541.54L511.62 291.5C509.31 290.58 506.28 287.2 507.53 284.78C508.28 283.28 511.27 281.49 516.11 283.39L555.36 300.11V300.1Z" fill="black"/>\n      </g>\n    </svg>',this.load(t,e),this.height=40,this.width=26.95,this.speed=360,this.vx=0,this.vy=0}tick(t){n()&&!h()?(this.vx=-t(this.speed),this.faceLeft=!0):h()&&!n()?(this.vx=t(this.speed),this.faceLeft=!1):this.vx=0,this.walking=n()||h()}get faceLeft(){return!!this._faceLeft}set faceLeft(t){this._faceLeft=!!t,this.element.classList.toggle("left",this.faceLeft)}get walking(){return!!this._walking}set walking(t){this._walking=!!t,this.element.classList.toggle("walk",this.walking)}load(t,e){this.x=t,this.y=e}toJSON(){return[Math.round(this.x),Math.round(this.y)]}}class f extends m{constructor(t,e,s,i,n){super(w("rect")),this.width=s,this.height=i,this.x=t,this.y=e,this.on=n}get on(){return!!this._on}set on(t){this._on=!!t,this.element.classList.toggle("light",this.on),this.element.classList.toggle("dark",!this.on)}toJSON(){return[Math.round(this.x),Math.round(this.y),Math.round(this.width),Math.round(this.height),Number(this.on)]}}const v=0,L=1,q=2,k=[v,L,q];class x extends m{constructor(t){super(document.getElementById("title")),this.game=t,this.items=[].slice.call(this.element.querySelectorAll(".menu .item")),this.selected=v,this.items.forEach((t,e)=>{t.addEventListener("click",()=>{this.selected=e,this.choose()})})}keydown({key:t}){switch(t){case"ArrowUp":this.selected-=1;break;case"ArrowDown":this.selected+=1;break;case"Enter":this.choose()}}choose(){switch(this.selected){case v:this.game.scene.index=0,this.game.scene.paused=!1,this.game.state="play";break;case q:this.game.state="edit";break;case L:this.game.state="controls"}}get selected(){return this._selected}set selected(t){this._selected=Math.min(k.length-1,Math.max(0,t||0)),this.items.forEach((t,e)=>{t.classList.toggle("selected",e===this.selected)})}}var E=440*Math.pow(Math.pow(2,1/12),-9),B=/^[0-9.]+$/,D=/\s+/,A=/(\d+)/,M={};"B#-C|C#-Db|D|D#-Eb|E-Fb|E#-F|F#-Gb|G|G#-Ab|A|A#-Bb|B-Cb".split("|").forEach(function(t,e){t.split("-").forEach(function(t){M[t]=e})});const C=function t(e){var s=e.split(D);this.frequency=t.getFrequency(s[0])||0,this.duration=t.getDuration(s[1])||0};C.getFrequency=function(t){var e=t.split(A),s=M[e[0]],i=(e[1]||4)-4;return E*Math.pow(Math.pow(2,1/12),s)*Math.pow(2,i)},C.getDuration=function(t){return B.test(t)?parseFloat(t):t.toLowerCase().split("").reduce(function(t,e){return t+("w"===e?4:"h"===e?2:"q"===e?1:"e"===e?.5:"s"===e?.25:0)},0)};const G=function(t,e,s){this.ac=t||new AudioContext,this.createFxNodes(),this.tempo=e||120,this.loop=!0,this.smoothing=0,this.staccato=0,this.notes=[],this.push.apply(this,s||[])};G.prototype.createFxNodes=function(){var t=this.gain=this.ac.createGain();return[["bass",100],["mid",1e3],["treble",2500]].forEach(function(e,s){(s=this[e[0]]=this.ac.createBiquadFilter()).type="peaking",s.frequency.value=e[1],t.connect(t=s)}.bind(this)),t.connect(this.ac.destination),this},G.prototype.push=function(){return Array.prototype.forEach.call(arguments,function(t){this.notes.push(t instanceof C?t:new C(t))}.bind(this)),this},G.prototype.createCustomWave=function(t,e){e||(e=t),this.waveType="custom",this.customWave=[new Float32Array(t),new Float32Array(e)]},G.prototype.createOscillator=function(){return this.stop(),this.osc=this.ac.createOscillator(),this.customWave?this.osc.setPeriodicWave(this.ac.createPeriodicWave.apply(this.ac,this.customWave)):this.osc.type=this.waveType||"square",this.osc.connect(this.gain),this},G.prototype.scheduleNote=function(t,e){var s=60/this.tempo*this.notes[t].duration,i=s*(1-(this.staccato||0));return this.setFrequency(this.notes[t].frequency,e),this.smoothing&&this.notes[t].frequency&&this.slide(t,e,i),this.setFrequency(0,e+i),e+s},G.prototype.getNextNote=function(t){return this.notes[t<this.notes.length-1?t+1:0]},G.prototype.getSlideStartDelay=function(t){return t-Math.min(t,60/this.tempo*this.smoothing)},G.prototype.slide=function(t,e,s){var i=this.getNextNote(t),n=this.getSlideStartDelay(s);return this.setFrequency(this.notes[t].frequency,e+n),this.rampFrequency(i.frequency,e+s),this},G.prototype.setFrequency=function(t,e){return this.osc.frequency.setValueAtTime(t,e),this},G.prototype.rampFrequency=function(t,e){return this.osc.frequency.linearRampToValueAtTime(t,e),this},G.prototype.play=function(t){return t="number"==typeof t?t:this.ac.currentTime,this.createOscillator(),this.osc.start(t),this.notes.forEach(function(e,s){t=this.scheduleNote(s,t)}.bind(this)),this.osc.stop(t),this.osc.onended=this.loop?this.play.bind(this,t):null,this},G.prototype.stop=function(){return this.osc&&(this.osc.onended=null,this.osc.disconnect(),this.osc=null),this};const F=new AudioContext,S=new G(F,100,["B2 q","- q","Db3 q","- q","D3 q","- q","Gb3 q","Bb3 q","B2 q","- q","Db3 q","- q","D3 q","- q","Gb3 q","B2 q","B2 q","- q","Db3 q","- q","D3 q","- q","Gb3 q","Bb3 q","B2 q","- q","Db3 q","- q","D3 q","- q","Gb3 q","B2 q","- 32"]),_=new G(F,100,["- w","- h","D3 q","Db3 q","- w","- h","D3 q","Gb3 q","- w","- h","D3 q","Db3 q","- w","- h","D3 q","Gb3 q","- 32"]),H=new G(F,100,["B4 e","- e","Bb4 e","- e","A4 s","A4 s","Ab4 e","G4 e","- e","Gb4 s","B4 s","Gb4 e","D4 e","B3 e","D4 e","- e","Db4 e","- e","B4 e","- e","Bb4 e","- e","A4 s","A4 s","Ab4 e","G4 e","- e","Gb4 s","B4 s","Gb4 e","D4 e","B3 e","D4 e","Db4 e","B3 e","- e","B4 e","- e","Bb4 e","- e","A4 s","A4 s","Ab4 e","G4 e","- e","Gb4 s","B4 s","Gb4 e","D4 e","B3 e","D4 e","- e","Db4 e","- e","B4 e","- e","Bb4 e","- e","A4 s","A4 s","Ab4 e","G4 e","- e","Gb4 s","B4 s","Gb4 e","D4 e","B3 e","D4 e","Db4 e","B3 e","- e","- 32"]),I=new G(F,100,["- 32","G3 e","E3 e","D3 e","C3 e","A2 e","G2 e","C2 e","Bb2 e","B2 e","Db3 e","D3 e","E3 e","Gb3 e","G3 e","Gb3 e","Bb2 e","G3 e","E3 e","D3 e","C3 e","A2 e","G2 e","C2 e","Bb2 e","B2 e","Db3 e","D3 e","E3 e","D3 e","Db3 e","B2 e","- e","G3 e","E3 e","D3 e","C3 e","A2 e","G2 e","C2 e","Bb2 e","B2 e","Db3 e","D3 e","E3 e","Gb3 e","G3 e","Gb3 e","Bb2 e","G3 e","E3 e","D3 e","C3 e","A2 e","G2 e","C2 e","Bb2 e","B2 e","Db3 e","D3 e","E3 e","D3 e","Db3 e","B2 e","- e"]),R=new G(F,100,["- 32","G4 w","Gb4 w","G4 w","Gb4 w","G4 w","Gb4 w","G4 w","Gb4 w"]),z=new G(F,100,["- 32","C4 w","D4 w","C4 w","D4 w","C4 w","D4 w","C4 w","D4 w"]),N=new G(F,200,["C3 q","- q","G3 q","- q","C3 q","- q","G3 q","G2 q","C3 q","- q","G3 q","- q","B2 q","- q","B2 q","A2 q","G2 q","- h","- q","E3 q","- h","- q","G2 q","- w","- h","B2 q"]),T=new G(F,200,["G4 e","Gb4 e","G4 e","Gb4 e","G4 q","A4 q","G4 h","C4 q","E4 q","G4 e","Gb4 e","G4 e","Gb4 e","G4 q","E4 q","F4 h","D4 q","E4 q","F4 e","E4 e","F4 e","E4 e","F4 q","G4 q","E4 e","D4 e","E4 e","D4 e","E4 q","F4 q","G3 e","A3 e","B3 e","C4 e","D4 e","E4 e","F4 e","E4 e","D4 e","C4 e","B3 e","A3 e","G3 q","E4 q"]);N.staccato=.3,T.staccato=.5,N.waveType="sine",N.gain.gain.value=.7,T.gain.gain.value=.3,S.staccato=.5,I.staccato=.3,_.staccato=.5,H.staccato=.5,S.waveType="sine",I.waveType="sine",_.waveType="sine",S.gain.gain.value=.4,I.gain.gain.value=.6,_.gain.gain.value=.4,H.gain.gain.value=.4;let U=1,O="up";setInterval(function(){"up"===O&&(U+=1)>9&&(O="down",U-=1),"down"===O&&(U-=1)<1&&(O="up",U+=2),R.gain.gain.value=.01*U,z.gain.gain.value=.01*U},300);const Z=()=>{S.play(),_.play(),H.play(),I.play(),R.play(),z.play(),N.stop(),T.stop()},P=()=>{S.stop(),_.stop(),H.stop(),I.stop(),R.stop(),z.stop(),N.play(),T.play()};Z();const V=new G(F,320,["Bb3 e","G5 e","Bb4 e"]),J=new G(F,400,["Bb6 e","D6 e"]),W=new G(F,400,["D6 e","Bb6 e"]),$=new G(F,280,["C4 s","G4 s","C5 h"]),K=new G(F,280,["Bb3 e","Bb2 q"]);V.loop=!1,$.loop=!1,K.loop=!1,J.loop=!1,W.loop=!1,V.smoothing=1,K.smoothing=.5,$.staccato=.2,J.staccato=.5,W.staccato=.5,K.waveType="sawtooth",K.bass.gain.value=10,V.gain.gain.value=.3,$.gain.gain.value=.6,K.gain.gain.value=.4,J.gain.gain.value=.3,W.gain.gain.value=.3;const j=768,X=480;class Y extends m{constructor(t){super(t),this.value=0}get value(){return this._value}set value(t){this._value=t||0,this.element.innerHTML="";let e=0;for(let t of this.value.toString()){const s=new m(w("rect"));s.element.setAttribute("fill",`url(#n${t})`),s.width=10,s.height=16,s.x=12*e++,this.append(s)}}}class Q extends m{constructor(t,e,s,i,n,h){super(w("svg")),this.rect=w("rect"),this.rect.setAttribute("x","0"),this.rect.setAttribute("y","0"),this.rect.setAttribute("width","100%"),this.rect.setAttribute("height","100%"),this.element.appendChild(this.rect),this.width=s,this.height=i,this.x=t,this.y=e,this.on=n,this.direction=h}get isUp(){return"up"===this.direction}get isDown(){return"down"===this.direction}get isLeft(){return"left"===this.direction}get isRight(){return"right"===this.direction}get width(){return super.width}set width(t){super.width=t,(this.isUp||this.isDown)&&this.element.setAttribute("width",16*Math.round(this.width/16))}get height(){return super.height}set height(t){super.height=t,(this.isLeft||this.isRight)&&this.element.setAttribute("height",16*Math.round(this.height/16))}get on(){return!!this._on}set on(t){this._on=!!t,this.element.classList.toggle("light",this.on),this.element.classList.toggle("dark",!this.on)}get direction(){return this._direction}set direction(t){this._direction=t,this.rect.setAttribute("fill",`url(#spike-${this.direction})`)}toJSON(){return[Math.round(this.x),Math.round(this.y),this.isUp||this.isDown?16*Math.round(this.width/16):this.width,this.isLeft||this.isRight?16*Math.round(this.height/16):this.height,Number(this.on),this.direction]}}class tt extends m{constructor(t,e){super(document.getElementById(t)),this.pressed=e}tick(){this.element.classList.toggle("dark",!this.pressed()),this.element.classList.toggle("light",this.pressed())}}class et extends m{constructor(s){super(document.getElementById("controls")),this.game=s,this.keys=[new tt("key-w",()=>t.has("w")),new tt("key-a",()=>t.has("a")),new tt("key-d",()=>t.has("d")),new tt("key-space",()=>t.has(" ")),new tt("button-toggle",()=>e.has(1)),new tt("button-jump",()=>e.has(0)),new tt("button-left",()=>e.has(14)),new tt("button-right",()=>e.has(15))]}keydown({key:t}){switch(t){case"Enter":this.game.state="title";break;case"ArrowUp":case"ArrowDown":this.element.querySelector(".menu .item").classList.add("selected")}}tick(){if(!this.hidden)for(const t of this.keys)t.tick()}}const st=3,it=document.getElementById("editor"),nt=it.createSVGPoint(),ht=({clientX:t,clientY:e})=>(nt.x=t,nt.y=e,nt.matrixTransform(it.getScreenCTM().inverse()));let ot=null,rt=null;document.addEventListener("mouseup",()=>{ot=rt=null}),document.addEventListener("mousedown",t=>{0===t.button&&(rt=ht(t))}),document.addEventListener("mousemove",t=>{if(!ot)return;const{x:e,y:s}=ht(t);ot({x:e-rt.x,y:s-rt.y}),rt={x:e,y:s}}),document.getElementById("close-dialog").addEventListener("click",()=>{document.getElementById("dialog").hidden=!0});class at extends f{constructor(...t){super(...t),this.element.addEventListener("dblclick",this.dblclick.bind(this)),this.element.addEventListener("mousemove",this.mousemove.bind(this)),this.element.addEventListener("mousedown",this.mousedown.bind(this))}dblclick(){this.on=!this.on}mousemove(t){const{x:e,y:s}=ht(t);this.element.style.cursor=this.cursor(this.region(e,s))}mousedown(t){if(0!==t.button)return;const{x:e,y:s}=ht(t);ot=this.resize.bind(this,this.region(e,s))}resize(t,{x:e,y:s}){switch(t){case"m":this.x+=e,this.y+=s;break;case"n":this.y+=s,this.height-=s;break;case"s":this.height+=s;break;case"e":this.width+=e;break;case"w":this.x+=e,this.width-=e;break;case"nw":this.resize("n",{x:e,y:s}),this.resize("w",{x:e,y:s});break;case"ne":this.resize("n",{x:e,y:s}),this.resize("e",{x:e,y:s});break;case"sw":this.resize("s",{x:e,y:s}),this.resize("w",{x:e,y:s});break;case"se":this.resize("s",{x:e,y:s}),this.resize("e",{x:e,y:s})}}region(t,e){return t-=this.x,e-=this.y,t<=st?e<=st?"nw":e<this.height-st?"w":"sw":t<this.width-st?e<=st?"n":e<this.height-st?"m":"s":e<=st?"ne":e<this.height-st?"e":"se"}cursor(t){switch(t){case"n":case"s":return"ns-resize";case"e":case"w":return"ew-resize";case"nw":case"se":return"nwse-resize";case"ne":case"sw":return"nesw-resize";case"m":return"move"}}}class dt extends Q{constructor(...t){super(...t),this.element.style.cursor="move",this.element.addEventListener("dblclick",this.dblclick.bind(this)),this.element.addEventListener("mousedown",this.mousedown.bind(this)),this.element.addEventListener("mousemove",this.mousemove.bind(this))}get direction(){return super.direction}set direction(t){super.direction=t,this.rect.setAttribute("fill",`url(#edit-spike-${this.direction})`)}dblclick(){this.on=!this.on}mousemove(t){const{x:e,y:s}=ht(t);this.element.style.cursor=this.cursor(this.region(e,s))}mousedown(t){if(0!==t.button)return;const{x:e,y:s}=ht(t);ot=this.resize.bind(this,this.region(e,s))}resize(t,{x:e,y:s}){switch(t){case"n":this.y+=s,this.height-=s;break;case"s":this.height+=s;break;case"e":this.width+=e;break;case"w":this.x+=e,this.width-=e;break;case"m":this.x+=e,this.y+=s}}region(t,e){return t-=this.x,e-=this.y,this.isUp||this.isDown?t<=st?"w":t<this.width-st?"m":"e":e<=st?"n":e<this.height-st?"m":"s"}cursor(t){switch(t){case"n":case"s":return"ns-resize";case"e":case"w":return"ew-resize";case"m":return"move"}}}class lt extends b{constructor(...t){super(...t),this.element.style.cursor="move",this.element.addEventListener("mousedown",this.mousedown.bind(this))}mousedown(t){0===t.button&&(ot=(({x:t,y:e})=>{this.x+=t,this.y+=e}))}}class ct extends y{constructor(...t){super(...t),this.element.style.cursor="move",this.element.addEventListener("mousedown",this.mousedown.bind(this))}mousedown(t){0===t.button&&(ot=(({x:t,y:e})=>{this.x+=t,this.y+=e}))}}class ut extends m{constructor(t,e){super(document.getElementById("editor")),this.bars=[],this.spikes=[],this.levels=t,this.game=e,this.guy=new lt,this.append(this.guy),this.goal=new ct,this.append(this.goal),this.level=0,document.addEventListener("keydown",this.keydown.bind(this))}addBar(t){this.bars.push(t),this.append(t),t.element.addEventListener("click",({shiftKey:e})=>{e&&(t.remove(),this.bars=this.bars.filter(e=>e===t))})}addSpike(t){this.spikes.push(t),this.append(t),t.element.addEventListener("click",({shiftKey:e})=>{e&&(t.remove(),this.spikes=this.spikes.filter(e=>e===t))})}get level(){return this._level}set level(t){this._level=Math.max(0,Math.min(this.levels.length-1,t));const[e,s,i,n]=this.levels[this.level];for(this.guy.load(...e),this.goal.load(...s);this.bars.length;)this.bars.pop().remove();for(const t of i)this.addBar(new at(...t));for(;this.spikes.length;)this.spikes.pop().remove();for(const t of n)this.addSpike(new dt(...t))}keydown({key:e}){if(!this.hidden)switch(e){case"ArrowRight":this.level+=1;break;case"ArrowLeft":this.level-=1;break;case"p":this.addBar(new at(0,0,48,48,!0));break;case"c":navigator.clipboard.writeText(JSON.stringify(this));break;case"u":case"d":case"l":case"r":if(!t.has("s"))return;this.addSpike("u"===e||"d"===e?new dt(0,0,64,8,!0,"u"===e?"up":"down"):new dt(0,0,8,64,!0,"l"===e?"left":"right"));break;case"h":document.getElementById("dialog").hidden=!document.getElementById("dialog").hidden;break;case"g":const s=new URL(window.location);s.searchParams.set("level",JSON.stringify(this)),window.location=s.toString();break;case"Escape":this.game&&(this.game.state="title")}}toJSON(){return[this.guy,this.goal,this.bars,this.spikes]}}window.onload=function(){function t(){return/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)}const e=document.querySelector(".touch-screen");console.log(e),console.log(t()),t()?e.style.display="block":e.style.display="none"};class gt extends m{constructor(t,e){super(document.getElementById("game")),this.deaths=new Y(document.getElementById("death-counter")),this.stars=new Y(document.getElementById("level-counter")),this.congrats=new m(document.getElementById("congrats")),this.esc=new m(document.getElementById("esc")),this.game=t,this.levels=e,this.bars=[],this.spikes=[],this.paused=!1,this.guy=new b,this.append(this.guy),this.goal=new y,this.append(this.goal),this.index=0}get fromURL(){return!!this._fromURL}set fromURL(t){this._fromURL=!!t,this.esc.hidden=!this.fromURL}keydown({key:t}){switch(t){case"Enter":this.finished&&(this.fromURL=!1,this.levels=g,this.game.state="title",Z());break;case"Escape":this.fromURL&&(this.fromURL=!1,this.levels=g,this.game.state="title",Z())}}get on(){return this._on}set on(t){this._on=t,document.body.classList.toggle("on",t),document.body.classList.toggle("off",!t)}get index(){return this._index}set index(t){for(this._index=Math.min(this.levels.length,Math.max(t||0)),this.on=!0,this.stars.value=this.index,localStorage.setItem("stars-collected",this.stars.value.toString());this.bars.length;)this.bars.pop().remove();for(;this.spikes.length;)this.spikes.pop().remove();if(this.finished)return this.guy.hidden=!0,this.congrats.hidden=!1,void P();const[e,s,i,n]=this.level;this.guy.load(...e),this.guy.hidden=!1,this.goal.load(...s),this.goal.hidden=!1,this.congrats.hidden=!0;for(const t of i){const e=new f(...t);this.append(e),this.bars.push(e)}for(const t of n){const e=new Q(...t);this.append(e),this.spikes.push(e)}}get level(){return this.levels[this.index]}get finished(){return this.index>=this.levels.length}async advance(){$.play(),this.paused=!0,document.body.classList.add("finish"),await p(1e3),this.index+=1,document.body.classList.remove("finish"),await p(1e3),this.finished?this.goal.hidden=!0:this.paused=!1}async death(){K.play(),this.deaths.value+=1,this.paused=!0;const t=document.getElementById("death");t.setAttribute("x",this.guy.x-32+this.guy.width/2),t.setAttribute("y",this.guy.y-32+this.guy.height/2),this.guy.element.setAttribute("hidden",!0),document.body.classList.add("dying"),await p(700),document.body.classList.remove("dying"),this.reset(),this.guy.element.removeAttribute("hidden"),this.paused=!1}reset(){this.guy.load(...this.level[0])}lost(){return this.guy.bottom>X||this.bars.some(t=>t.on===this.on&&t.overlaps(this.guy))||this.spikes.some(t=>t.on===this.on&&t.overlaps(this.guy))}setBounds(t){const{bounds:e}=t;e.left=-t.left,e.right=j-t.right,e.top=-t.top,e.bottom=X-t.bottom+1;for(const s of this.bars)s.on===this.on&&(s.top<t.bottom&&s.bottom>t.top&&(s.isRightOf(t)?e.right=Math.min(e.right,s.left-t.right):s.isLeftOf(t)&&(e.left=Math.max(e.left,s.right-t.left))),s.left<t.right&&s.right>t.left&&(s.isBelow(t)?e.bottom=Math.min(e.bottom,s.top-t.bottom):s.isAbove(t)&&(e.top=Math.max(e.top,s.bottom-t.top))));return e}tick(t){if(this.paused||this.hidden)return;this.guy.tick(t);const{left:e,right:s}=this.setBounds(this.guy);this.guy.x+=Math.min(s,Math.max(e,this.guy.vx));const{top:n,bottom:h}=this.setBounds(this.guy);this.guy.y+=Math.min(h,Math.max(n,this.guy.vy)),0===h?(this.guy.vy=i()?-t(2e3):0,i()&&V.play()):this.guy.vy=Math.min(t(600),this.guy.vy+t(120)),this.lost()?this.death():this.guy.overlaps(this.goal)&&this.advance()}}const pt=new class{constructor(){this.title=new x(this),this.controls=new et(this),this.scene=new gt(this,g),this.editor=new ut([[[100,300],[500,300],[[84,361,362,48,1]],[[446,401,176,8,1,"up"]]]],this),this.dialog=document.getElementById("dialog"),document.addEventListener("keydown",this.keydown.bind(this));const t=document.querySelector("#toggle-button");t&&(t.addEventListener("mousedown",()=>this.toggle()),t.addEventListener("touchstart",t=>{t.preventDefault(),this.toggle()})),c(1,this.toggle.bind(this))}toggle(){this.scene.on=!this.scene.on,this.scene.on?W.play():J.play()}keydown(t){if("Enter"===t.key){const t=document.getElementById("watch-video");t&&(t.style.display="none")}" "===t.key&&this.toggle(),this.scene.hidden?this.controls.hidden?this.title.hidden||this.title.keydown(t):this.controls.keydown(t):this.scene.keydown(t)}get state(){return this._state}set state(t){this._state=t,this.scene.hidden="play"!==this.state,this.title.hidden="title"!==this.state,this.controls.hidden="controls"!==this.state,this.editor.hidden="edit"!==this.state,this.dialog.hidden="edit"!==this.state}tick(t){this.scene.tick(t),this.controls.tick(t)}},mt=new URL(window.location).searchParams.get("level");if(mt)try{pt.scene.levels=[JSON.parse(mt)],pt.scene.fromURL=!0,pt.scene.index=0,pt.state="play"}catch(t){}let wt=0;requestAnimationFrame(function t(e){const s=e-wt;pt.tick(t=>Math.round(t*s/1e3)),wt=e,requestAnimationFrame(t)});
